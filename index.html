<!DOCTYPE html>
<html>
  <head>
    <title>WebRTC Screen Share</title>
  </head>
  <body>
    <h1>Pantalla Compartida</h1>
    <video id="video" autoplay playsinline style="width: 100%"></video>
    <button id="start" onclick="start()">Start</button>
    <button id="restart" onclick="restartEmitter()">Reiniciar Emisor</button>

    <script>
      const video = document.getElementById("video");
      let ws;
      let pc;

      function connectWebSocket() {
        ws = new WebSocket("ws://localhost:8080/offer");
        console.log("connecting...");

        ws.onopen = () => {
          pc.createOffer()
            .then((offer) => {
              return pc.setLocalDescription(offer);
            })
            .then(() => {
              ws.send(
                JSON.stringify({
                  sdp: pc.localDescription.sdp,
                  type: pc.localDescription.type,
                })
              );
            });
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          pc.setRemoteDescription(
            new RTCSessionDescription({
              sdp: data.sdp,
              type: data.type,
            })
          );
        };

      }

      function start() {
        pc = new RTCPeerConnection({
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            {
              urls: "turn:your-turn-server.com",
              username: "user",
              credential: "pass",
            },
          ],
          offerToReceiveAudio: false,
          offerToReceiveVideo: true,
        });

        pc.addEventListener("track", (evt) => {
          if (evt.track.kind === "video") {
            video.srcObject = evt.streams[0];
          }
        });

        pc.addTransceiver("video", { direction: "recvonly" });

        // Inicializar WebSocket
        connectWebSocket();

        // Keep-alive ping cada 10 segundos
         // Enviar ping cada 10 segundos
      }

      // Evento para detectar cuando la p치gina se cierra o recarga
      window.onbeforeunload = function () {
        if (pc) {
          pc.close();
        }
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ action: "restart_emitter" }));
          ws.close();
        }
      };

      // Funci칩n para reiniciar el emisor manualmente con un bot칩n
      function restartEmitter() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ action: "restart_emitter" }));
        } else {
          console.error("WebSocket no est치 conectado.");
        }
      }
    </script>
  </body>
</html>
