<!DOCTYPE html>
<html>
  <head>
    <title>WebRTC Screen and Camera Share</title>
  </head>
  <body>
    <h1>Pantalla y Cámara Compartida</h1>
    
    <video id="videoScreen" autoplay playsinline style="width: 50%"></video>
    <video id="videoCamera" autoplay playsinline style="width: 50%"></video>

    <h2>Controles del Emisor 1</h2>
    <button id="start1" onclick="start('emisor_1')">Start Emisor 1</button>
    <button id="restart1" onclick="restartEmitter('emisor_1')">Reiniciar Emisor 1</button>

    <h2>Controles del Emisor 2</h2>
    <button id="start2" onclick="start('emisor_2')">Start Emisor 2</button>
    <button id="restart2" onclick="restartEmitter('emisor_2')">Reiniciar Emisor 2</button>

    <script>
      const videoScreen = document.getElementById("videoScreen");
      const videoCamera = document.getElementById("videoCamera");
      let ws;
      let pc;
      let idVideo;

      function connectWebSocket(emitterId) {
        ws = new WebSocket("ws://localhost:8000/viewer_offer");
        console.log("Conectando como cliente...");

        ws.onopen = async () => {
          try {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(
              JSON.stringify({
                sdp: pc.localDescription.sdp,
                type: pc.localDescription.type,
                emitter_id: emitterId,  // Se envía el emitter_id seleccionado
              })
            );
          } catch (err) {
            console.error("Error creando la oferta", err);
          }
        };

        ws.onmessage = async (event) => {
          const data = JSON.parse(event.data);
          if (data.sdp && data.type) {
            await pc.setRemoteDescription(
              new RTCSessionDescription({
                sdp: data.sdp,
                type: data.type,
              })
            );
          } else {
            console.log("Mensaje no reconocido:", data);
          }
        };
      }

      function start(emitterId) {
        pc = new RTCPeerConnection({
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            {
              urls: "turn:your-turn-server.com",
              username: "user",
              credential: "pass",
            },
          ],
        });

        pc.addEventListener("track", (evt) => {
          videoScreen.srcObject = evt.streams[0];
          const track = event.track;
          console.log("Track received:", evt.track);
          if (evt.track.kind === "video") {
            if (!idVideo) {
              console.log("screen");
              console.log("Track received:", evt.track.id);
              idVideo = evt.track.id;
              videoScreen.srcObject = new MediaStream([track]);;
            } else {
              console.log("camera");
              console.log("Track received:", evt.track.id);
              idVideo = evt.track.id;
              videoCamera.srcObject = new MediaStream([track]);;
            }
          }
        });

        pc.addTransceiver("video", { direction: "recvonly" });
        pc.addTransceiver("video", { direction: "recvonly" });

        connectWebSocket(emitterId);  // Se conecta al WebSocket usando el emitter_id
      }

      function restartEmitter(emitterId) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ action: "restart_emitter", emitter_id: emitterId }));
        } else {
          console.error("WebSocket no está conectado.");
        }
      }
    </script>
  </body>
</html>
